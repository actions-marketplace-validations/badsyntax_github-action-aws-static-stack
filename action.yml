name: 'AWS Edge Static Stack'
description: 'Deploy your static website to the AWS Edge using S3, CloudFront & Lambda@Edge'
author: 'Richard Willis <willis.rh@gmail.com>'
branding:
  icon: 'upload-cloud'
  color: 'gray-dark'
inputs:
  cfStackName:
    required: true
    description: 'The name of the Cloudformation stack to be created. For example: example-com-static-cloudformation-stack'
  cfTemplate:
    required: true
    description: 'The relative path to the CloudFormation stack template. For example: ./cloudformation/s3bucket_with_cloudfront.yml'
  cfApplyChangeSet:
    required: true
    description: 'Whether to apply the CloudFormation ChangeSet (if any)'
  gitHubToken:
    required: true
    description: 'GitHub Token used for commenting on Pull Requests. Use the default GITHUB_TOKEN from secrets.'
  awsRegion:
    require: true
    description: 'The AWS region in which to create the stack. You should set this to: us-east-1'
  s3BucketName:
    required: true
    description: 'The name of S3 bucket to be created, to store your static files. Must end with region name, for example: example.com-us-east-1'
  s3AllowedOrigins:
    required: true
    description: 'A list of allowed domains to request resources from S3. For example: https://example.com,https://*.preview.example.com'
  cloudFrontRootHosts:
    required: true
    description: 'A list of hosts assigned to the Root CloudFront distribution. For example: example.com'
  cloudFrontPreviewHosts:
    required: true
    description: 'A list of hosts assigned to the Preview CloudFront distribution. For example: *.preview.example.com'
  cloudFrontDefaultRootObject:
    required: true
    description: 'The CloudFront default root object. For example: index.html'
  certificateARN:
    required: true
    description: 'ARN of the certificate for the root and preview domains. For example: arn:aws:acm:us-east-1:1234567:certificate/123abc-123abc-1234-5678-abcdef'
  srcDir:
    required: true
    description: 'Path to build/out directory that contains the static files. For example: ./out'
  staticFilesGlob:
    required: true
    description: 'Glob pattern for immutable static files. For example: _next/**'
  lambdaVersion:
    required: true
    description: 'The lambda version. Required to deploy a new lambda. You must update this if changing the lambda. For example: 1.0.0'
  deletePreviewSiteOnPRClose:
    required: true
    description: 'Whether to delete the preview site on PR close'
  commentTemplate:
    required: true
    description: 'Path to the Pull Request comment template. For example: .github/preview-site-comment.md'

runs:
  using: 'composite'
  steps:
    - uses: actions/github-script@v5
      name: Set vars
      id: vars
      with:
        script: |
          const isPullRequest = context.eventName === 'pull_request';
          const prBranchName = isPullRequest
            ? context.payload.pull_request.head.ref.replace(/\//g, '-')
            : '';
          const prefix = isPullRequest ? `preview/${prBranchName}` : 'root';
          core.setOutput('sanitizedBranchName', prBranchName);
          core.setOutput('prefix', prefix);

    - uses: badsyntax/github-action-aws-cloudformation@v0.0.3
      name: Update CloudFormation Stack
      id: update-stack
      with:
        githubToken: ${{ inputs.gitHubToken }}
        stackName: ${{ inputs.cfStackName }}
        template: ${{ inputs.cfTemplate }}
        applyChangeSet: ${{ inputs.cfApplyChangeSet }}
        awsRegion: ${{ inputs.awsRegion }}
        parameters: |
          S3BucketName=${{ inputs.s3BucketName }}&
          S3AllowedOrigins=${{ inputs.s3AllowedOrigins }}&
          CloudFrontRootHosts=${{ inputs.cloudFrontRootHosts }}&
          CloudFrontPreviewHosts=${{ inputs.cloudFrontPreviewHosts }}&
          CertificateARN=${{ inputs.certificateARN }}&
          CloudFrontDefaultRootObject=${{ inputs.cloudFrontDefaultRootObject }}&
          LambdaVersion=${{ inputs.lambdaVersion }}

    - uses: badsyntax/github-action-aws-s3@v0.0.2
      name: Sync mutable HTML files to S3
      id: sync-html-s3
      if: github.event_name != 'pull_request' || github.event.action != 'closed'
      with:
        bucket: ${{ steps.update-stack.outputs.S3BucketName }}
        action: 'sync'
        srcDir: ${{ inputs.srcDir }}
        filesGlob: '**/*.html'
        awsRegion: ${{ inputs.awsRegion }}
        prefix: ${{ steps.vars.outputs.prefix }}
        stripExtensionGlob: '**/**.html'
        cacheControl: 'public,max-age=0,s-maxage=31536000,must-revalidate'

    - uses: badsyntax/github-action-aws-s3@v0.0.2
      name: Sync immutable files to S3
      id: sync-immutable-s3
      if: github.event_name != 'pull_request' || github.event.action != 'closed'
      with:
        bucket: ${{ steps.update-stack.outputs.S3BucketName }}
        action: 'sync'
        srcDir: ${{ inputs.srcDir }}
        filesGlob: ${{ inputs.staticFilesGlob }}
        awsRegion: ${{ inputs.awsRegion }}
        prefix: ${{ steps.vars.outputs.prefix }}
        cacheControl: 'public,max-age=31536000,immutable'

    - uses: actions/github-script@v5
      name: Set CloudFront Distribution Id
      id: cloudfront-distribution-id
      with:
        script: |
          const distributionId =
            context.eventName === 'pull_request'
              ? '${{ steps.update-stack.outputs.CFDistributionPreviewId }}'
              : '${{ steps.update-stack.outputs.CFDistributionRootId }}';
          core.setOutput('distributionId', distributionId);

    - uses: badsyntax/github-action-aws-cloudfront@v0.0.1
      name: Invalidate CloudFront Cache
      id: invalidate-cloudfront-cache
      if: github.event_name != 'pull_request' || github.event.action != 'closed'
      with:
        distributionId: ${{ steps.cloudfront-distribution-id.outputs.distributionId }}
        awsRegion: ${{ inputs.awsRegion }}
        originPrefix: ${{ steps.vars.outputs.prefix }}
        includeOriginPrefix: ${{ github.event_name == 'pull_request' }}
        invalidatePaths: ${{ steps.sync-html-s3.outputs.modifiedKeys }}
        defaultRootObject: ${{ inputs.cloudFrontDefaultRootObject }}

    - name: Pull Request Comment Body Template
      if: github.event_name == 'pull_request' && github.event.action != 'closed'
      id: pr-body-template
      uses: chuhlomin/render-template@v1.2
      with:
        template: ${{ inputs.commentTemplate }}
        vars: |
          issueNumber: ${{ github.event.pull_request.number }}
          branchName: ${{ steps.vars.outputs.sanitizedBranchName }}

    - name: Pull Request Comment Body With Id
      uses: actions/github-script@v5
      id: pr-body
      with:
        script: |
          core.setOutput(
            'body',
            `Deploy Site (ID: ${{ github.event.pull_request.number }})\n\n${{ steps.pr-body-template.outputs.result }}`
          );

    - name: Find PR Comment
      uses: peter-evans/find-comment@v1
      if: github.event_name == 'pull_request'
      id: find-comment
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body-includes: 'Deploy Site (ID: ${{ github.event.pull_request.number }})'

    - name: Delete comment
      uses: actions/github-script@v5
      if: github.event_name == 'pull_request' && github.event.action != 'closed' && steps.find-comment.outputs.comment-id != ''
      with:
        script: |
          await github.rest.issues.deleteComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: ${{ steps.find-comment.outputs.comment-id }},
          });

    - name: Create comment
      if: github.event_name == 'pull_request' && github.event.action != 'closed'
      uses: peter-evans/create-or-update-comment@v1
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body: ${{ steps.pr-body.outputs.body }}

    - uses: badsyntax/github-action-aws-s3@v0.0.2
      name: Delete Preview Files in S3
      id: delete-preview-files
      if: github.event_name == 'pull_request' && github.event.action == 'closed' && inputs.deletePreviewSiteOnPRClose == 'true'
      with:
        bucket: ${{ steps.update-stack.outputs.S3BucketName }}
        action: 'clean'
        srcDir: ${{ inputs.srcDir }}
        filesGlob: '**/*'
        awsRegion: ${{ inputs.awsRegion }}
        prefix: ${{ steps.vars.outputs.prefix }}

    - uses: badsyntax/github-action-aws-cloudfront@v0.0.1
      name: Invalidate CloudFront Cache
      id: invalidate-cloudfront-cache-delete
      if: github.event_name == 'pull_request' && github.event.action == 'closed' && inputs.deletePreviewSiteOnPRClose == 'true'
      with:
        distributionId: ${{ steps.cloudfront-distribution-id.outputs.distributionId }}
        awsRegion: ${{ inputs.awsRegion }}
        originPrefix: ${{ steps.vars.outputs.prefix }}
        includeOriginPrefix: ${{ github.event_name == 'pull_request' }}
        invalidatePaths: ${{ steps.delete-preview-files.outputs.modifiedKeys }}
        defaultRootObject: ${{ inputs.cloudFrontDefaultRootObject }}

    - name: Delete comment
      uses: actions/github-script@v5
      if: github.event_name == 'pull_request' && github.event.action == 'closed' && steps.find-comment.outputs.comment-id != '' && inputs.deletePreviewSiteOnPRClose == 'true'
      with:
        script: |
          await github.rest.issues.deleteComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: ${{ steps.find-comment.outputs.comment-id }},
          });
